---
title: "PhilaFire_PropensityScore"
author: "Ben Keel"
date: "2023-03-20"
output: html_document
---

# Set Up

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(boxr)
library(mapview)
library(sf)
library(tidyverse)
library(knitr)
library(kableExtra)
library(tigris)
library(viridis)
library(dplyr)
library(tidycensus)
library(ggplot2)
library(RSocrata)
library(lubridate)
library(janitor)
library(MatchIt)

options(scipen = 999)
mapTheme <- theme(plot.title =element_text(size=12),
                  plot.subtitle = element_text(size=8),
                  plot.caption = element_text(size = 6),
                  axis.line=element_blank(),
                  axis.text.x=element_blank(),
                  axis.text.y=element_blank(),
                  axis.ticks=element_blank(),
                  axis.title.x=element_blank(),
                  axis.title.y=element_blank(),
                  panel.background=element_blank(),
                  panel.border=element_blank(),
                  panel.grid.major=element_line(colour = 'transparent'),
                  panel.grid.minor=element_blank(),
                  legend.direction = "vertical", 
                  legend.position = "right",
                  plot.margin = margin(1, 1, 1, 1, 'cm'),
                  legend.key.height = unit(1, "cm"), legend.key.width = unit(0.2, "cm"))

#Color Palettes
palette3_sat <- c("#e19825","#d55816","#7b230b")
palette3_desat <- c("#B19C7D","#7F5F52","#262626")

palette4 <- c("#f1c82b","#e19825","#d55816","#7b230b")
palette4_desat <- c("#B19C7D","#B27D49","#7F5F52","#262626")

palette5_sat <- c("#f1c82b","#e19825","#d55816","#7b230b","#413028")
pallette5_desat <- c("#ead5b7","#d2b190","#b18e6f","#7f5f52","#413028")

palette6_sat <- c("white","#f1c82b","#e19825","#d55816","#7b230b","#413028")


palette7_cats <- c("#b9cfcf","#20b1ae","#e19825","#7b230b","#b47c49", "#3f3128", "#8f8172")

#Sources for Graphs
creditFire <- "Source: Philadelphia Fire Department"
creditOpen <- "Source: Open Data Philly"

g<-glimpse

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

crs <- "EPSG:4326"
PHL_crs <- 'ESRI:102411' #This measurement-based CRS projection is for the West Coast

```

#Process

1. Load in results, as we captured in EDA.

2. Add open data covariates (OPA, ACS, Transfer Values) to those results.

3. Check mean (0 to 1) or of results for each test group. 

# Tying the Sample Code to Our Own Data

<https://sejdemyr.github.io/r-tutorials/statistics/tutorial8.html>

## In the sample data:

Outcome variable of interest: standardized math score

Independent variable of interest: Catholic School y/n

Covariates:

-   race_white: Is the student white (1) or not (0)?

-   p5hmage: Mother's age

-   w3income: Family income

-   p5numpla: Number of places the student has lived for at least 4 months

-   w3momed_hsb: Is the mother's education level high-school or below (1) or some college or more (0)?

## In our data:

Outcome variable of interest: Vacancy / Permits / Transfers

Independent variable of interest: Fire y/n

-   Structure Fires Spatialized

    -   address (ID)

Covariates:

-   OPA Data (Tab Join)

    -   address (ID)
    
    -   building_code (categorical)
    
    -   total_livable_area (continuous)

    -   number_of_bedrooms (continuous)
    
    -   number_of_bathrooms (continuous)
    
    -   year_built (continuous)
    
    -   quality_grade (ordinal)
    
    -   owner occupied (t/f)
    
    -   assessment price/sqft (continuous)

-   ACS Data (Spatial Join)

    -   Tract Average Income (continuous)
    
    -   Tract average White racial makeup % (continuous)
    
-   Neighborhoods (Spatial Join)

    -   NHood Name
    
-   Transfers Data (optional)
    
    -   Sales price of 5 nearest buildings (continous) 

#Data Imports

## Fire Data

### Loading In

```{r Box Set Up, message=FALSE, warning=FALSE}

## INSERT BOX WORKFLOW HERE ##

#Box Upload Philadelphia Structure Fire


```

### Cleaning

```{r Cleaning The Dataset}
# Creating geometry for the fires
dat <- structureFire

dat <- dat %>% drop_na("Longitude", "Latitude") %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = "EPSG:4326")

# Cleaning the column names
dat <- clean_names(dat)

# Address string
dat <-
  dat %>% mutate(street_type = ifelse(street_type == 'AV', "AVE", street_type)) %>% 
  unite(address, c('address_number', 'street_prefix', 'street_name', 'street_type'), sep = " ", remove = FALSE, na.rm=TRUE)

# Extracting quarter
dat <- dat %>% mutate(quarter = floor_date(alarm_date, unit="quarter"))

# Reducing columns
dat <- dat %>%
  dplyr::select(address, quarter, property_use, incident_number, number_of_exposures, incident_type, building_status, fire_spread, no_spread, code_description, geometry, alarm_date, cad_nature_code_description,
                minor_damage, significant_damage, heavy_damage, extreme_damage)

# Removing duplicates
dat <- dat[!duplicated(dat$incident_number),]

dat_boolean <- dat%>%
  st_drop_geometry%>%
  mutate(fire = 1)%>%
  dplyr::select(address, fire)

```

## ACS Philadelphia

### Variables

```{r Key and Variables}

census_api_key("3c9540be1434ac4b38e6e55d60e8ee95909f2254", overwrite = TRUE)

#Variables
acs_variable_list.2020 <- load_variables(2020, #year
                                         "acs5", #five year ACS estimates
                                         cache = TRUE)

acs_variable_list.2016 <- load_variables(2016, #year
                                         "acs5", #five year ACS estimates
                                         cache = TRUE)

```

### Loading

```{r ACS Data Loading, warning=FALSE, message=FALSE}

acs_vars <- c("B02001_001E", #Total Population
              "B02001_002E", #Total Population White Only
              "B19013_001E" #Median HH Income
              )

acsTractsPHL.2020 <- get_acs(geography = "tract",
                             year = 2020, 
                             variables = acs_vars, 
                             geometry = TRUE, 
                             state = "PA", 
                             county = "Philadelphia", 
                             output = "wide")%>%
  rename(Total_Pop = B02001_001E,
         Total_Pop_WhiteOnly = B02001_002E,
         Med_Income = B19013_001E)%>%
  mutate(Perc_White = Total_Pop_WhiteOnly/Total_Pop)%>%
  dplyr::select(-B02001_001M, -B02001_002M, -B19013_001M, -Total_Pop_WhiteOnly)%>%
  st_set_crs("EPSG:4326")

```

## OPA Data

### Loading

```{r OPA Data Import}
# Reading the data
opa_dat <- read_csv("../Data/OpenDataPhilly-opa_properties_public.csv")

# Creating geometry for the properties
opa_dat <- opa_dat%>%
  drop_na(lat, lng)%>%
  st_as_sf(coords = c("lat", "lng"),
           crs = "EPSG:4326")
```

### Cleaning

```{r OPA Data Cleaning}

# Reducing columns
opa_ps <- opa_dat[!duplicated(opa_dat$location),] %>%
  dplyr::select(location, category_code, category_code_description, building_code, building_code_description, total_area, total_livable_area, market_value, mailing_street, number_of_bedrooms, number_of_bathrooms, number_stories, year_built, quality_grade)%>%
  filter(category_code == 1 | category_code == 2 | category_code == 3)%>%
  mutate(Price_Sqft = ifelse(is.na(total_livable_area) == FALSE & total_livable_area != 0, market_value / total_area, NA),
         quality_grade_mod = case_when(quality_grade == 1 ~ "E",
                                   quality_grade == 2 ~ "D",
                                   quality_grade == 3 ~ "C",
                                   quality_grade == 4 ~ "B",
                                   quality_grade == 5 ~ "A",
                                   quality_grade == 6 ~ "A+", 
                                   TRUE ~ quality_grade,
                                   ))%>%
  rename(address = location)%>%
  mutate(condo = ifelse(grepl("CONDO", building_code_description) == TRUE, TRUE, FALSE),
        owner_occ = ifelse(condo == FALSE & category_code_description != "MULTI FAMILY",
                           ifelse(address == mailing_street, TRUE, FALSE),
                           NA))%>%
  filter(Price_Sqft < 100000)%>%
  dplyr::select(-quality_grade)

opa_ps$quality_grade_mod <- factor(opa_ps$quality_grade_mod, order = TRUE,
                               levels = c("A+", "A", "A-", "B+", "B", "B-", "C+", "C", "C-", "D+", "D", "D-", "E+", "E", "E-"))


```
## Neighborhoods

### Loading In

```{r}

#https://github.com/azavea/geo-data

nhoods <- st_read("../Data/Neighborhoods_Philadelphia.geojson")%>%
  st_set_crs("EPSG:4326")

```


## Combining Data

```{r Tabular and Spatial Join }

#Fires
opa_fire <- opa_ps%>%
  left_join(dat_boolean, by="address")

opa_fire$fire <- as.factor(ifelse(is.na(opa_fire$fire), 0, 1))

#ACS and NHoods
opa_sf <- opa_fire%>%
  st_join(acsTractsPHL.2020)%>%
  st_join(nhoods)

```

# PreTests
```{r }

g(filter(opa_sf, total_livable_area > 10000))

opa_sf_cov <- c('total_livable_area', 'number_of_bedrooms', 'Price_Sqft', 'Med_Income', 'owner_occ', 'Perc_White', 'quality_grade_mod', 'name')

opa_sf %>%
  filter(total_livable_area < 10000,
       Price_Sqft < 10000)%>%
  st_drop_geometry()%>%
  group_by(fire) %>%
  dplyr::select(one_of(opa_sf_cov)) %>%
  summarise_all(funs(mean(., na.rm = T)))

```

```{r}

#with(opa_sf, t.test(total_livable_area ~ fire)) 

```

# Propensity Score Estimation

```{r}

g(opa_sf)

m_ps <- glm(fire ~ total_livable_area + number_of_bedrooms + Price_Sqft + Med_Income + Perc_White, 
            family = binomial(), data = opa_sf)

summary(m_ps)


m_ps2 <- glm(fire ~ total_livable_area + number_of_bedrooms + Price_Sqft + Med_Income + Perc_White + owner_occ + quality_grade_mod + name, 
            family = binomial(), data = opa_sf)

summary(m_ps2)

```

```{r}

prs_df <- data.frame(pr_score = predict(m_ps2, type = "response"),
                     fire = m_ps2$model$fire)
head(prs_df)

```

# REgion of common support

```{r}

labs <- paste("Actual school type attended:", c("Fire", "No Fire"))
prs_df %>%
  mutate(fire = ifelse(fire == 1, labs[1], labs[2])) %>%
  ggplot(aes(x = pr_score)) +
  geom_histogram(color = "white") +
  facet_wrap(~fire) +
  xlab("Probability of Having A Fire") +
  theme_bw()

```

# Matching Algorithm

```{r}

opa_nomiss <- opa_sf %>%  # MatchIt does not allow missing values
  dplyr::select(address, fire, one_of(opa_sf_cov)) %>%
  na.omit()

mod_match <- matchit(fire ~ total_livable_area + number_of_bedrooms + Price_Sqft + Med_Income + Perc_White + owner_occ + quality_grade_mod + name,
                     method = "nearest", data = opa_nomiss)

```

```{r}

dta_m <- match.data(mod_match)
dim(dta_m)

box_write(dta_m, "propMatch_v02.csv")

```

# Examining covariate balance in matched sample

```{r}

table()

fn_bal <- function(dta, variable) {
  dta$variable <- dta[, variable]
  if (variable == 'w3income') dta$variable <- dta$variable / 10^3
  dta$fire <- as.factor(dta$fire)
  support <- c(min(dta$variable), max(dta$variable))
  ggplot(dta, aes(x = distance, y = variable, color = fire)) +
    geom_point(alpha = 0.2, size = 1.3) +
    geom_smooth(method = "loess", se = F) +
    xlab("Propensity score") +
    ylab(variable) +
    theme_bw() +
    ylim(support)
}

library(gridExtra)
grid.arrange(
   fn_bal(dta_m, "total_livable_area"),
   fn_bal(dta_m, "number_of_bedrooms") + theme(legend.position = "none"),
   fn_bal(dta_m, "Price_Sqft"),
   fn_bal(dta_m, "Med_Income") + theme(legend.position = "none"),
   fn_bal(dta_m, "Perc_White"),
   nrow = 3, widths = c(1, 0.8)
)

```

#Difference In Means

```{r}

dta_m %>%
  st_drop_geometry()%>%
  group_by(fire) %>%
  dplyr::select(one_of(opa_sf_cov)) %>%
  summarize_all(funs(mean))

```

```{r}

dta_m%>%
  filter(subclass == 1466)

dta_m%>%
  filter(address == "8105 THOURON AVE")

```

```{r}

lapply(ecls_cov, function(v) {
    t.test(dta_m[, v] ~ dta_m$catholic)
})

```

# Estimating Treatment Effects

```{r}

with(dta_m, t.test(c5r2mtsc_std ~ catholic))

```

```{r}

lm_treat1 <- lm(c5r2mtsc_std ~ catholic, data = dta_m)
summary(lm_treat1)

```

```{r}

lm_treat2 <- lm(c5r2mtsc_std ~ catholic + race_white + p5hmage +
                  I(w3income / 10^3) + p5numpla + w3momed_hsb, data = dta_m)
summary(lm_treat2)

```

